<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoTSP PPT ç¼–è¾‘å™¨ Pro (ä¿®å¤å­—ä½“ç‰ˆ)</title>
    <!-- å¼•å…¥ PptxGenJS (ç”ŸæˆPPT) -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <!-- å¼•å…¥ html2canvas (ç”Ÿæˆå›¾ç‰‡) -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* === å…¨å±€å˜é‡ === */
        :root {
            --primary: #000000;
            --accent: #023163;
            --bg: #f0f2f5;
            --slide-w: 960px;
            --slide-h: 540px;
            --sidebar-w: 220px;
            /* æ ¸å¿ƒä¿®å¤ï¼šå®šä¹‰å®Œæ•´çš„æ¥·ä½“å­—ä½“æ ˆï¼Œå…¼å®¹ Win/Mac */
            --font-stack: "KaiTi", "æ¥·ä½“", "STKaiti", "åæ–‡æ¥·ä½“", "Kiwi Maru", serif;
        }
        
        body { 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            background: var(--bg); 
            font-family: var(--font-stack); 
            overflow: hidden; 
        }

        /* === ä¾§è¾¹æ  === */
        #sidebar { 
            width: var(--sidebar-w); 
            background: white; 
            border-right: 1px solid #ddd; 
            display: flex; 
            flex-direction: column; 
            z-index: 10;
        }
        #sidebar-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; color: var(--accent); }
        #sidebar-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .thumb { 
            padding: 12px; 
            background: #fff; 
            border: 2px solid #eee; 
            cursor: pointer; 
            margin-bottom: 10px; 
            border-radius: 4px; 
            font-size: 14px;
            display: flex; 
            justify-content: space-between;
            font-family: var(--font-stack); /* ä¾§è¾¹æ ä¹Ÿåº”ç”¨å­—ä½“ */
        }
        .thumb:hover { border-color: #ccc; }
        .thumb.active { border-color: var(--accent); background: #eef2f6; color: var(--accent); font-weight: bold; }
        .thumb-status { font-size: 12px; color: #999; }

        /* === ä¸»å·¥ä½œåŒº === */
        #main { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }
        
        /* å·¥å…·æ  */
        #toolbar { 
            height: 50px; 
            background: white; 
            border-bottom: 1px solid #ddd; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 20;
        }
        .tool-group { display: flex; align-items: center; gap: 15px; }
        button { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: 0.2s; font-family: sans-serif; }
        button:hover { opacity: 0.9; }
        button.secondary { background: #555; }
        button.secondary:hover { background: #333; }

        /* ç”»å¸ƒæ»šåŠ¨åŒº */
        #workspace { 
            flex: 1; 
            overflow: auto; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            padding: 40px; 
            background: var(--bg);
        }

        /* PPT ç”»å¸ƒå®¹å™¨ */
        #canvas-wrapper { 
            position: relative; 
            box-shadow: 0 0 20px rgba(0,0,0,0.15); 
            border: 1px solid #ccc;
        }
        #canvas { 
            width: var(--slide-w); 
            height: var(--slide-h); 
            background: white; 
            position: relative; 
            overflow: hidden; 
            /* æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶ç”»å¸ƒä½¿ç”¨æŒ‡å®šå­—ä½“ï¼Œé˜²æ­¢ html2canvas æ— æ³•è¯»å–ç»§æ‰¿æ ·å¼ */
            font-family: var(--font-stack);
            /* ä¼˜åŒ–å­—ä½“æ¸²æŸ“ */
            text-rendering: geometricPrecision;
            -webkit-font-smoothing: antialiased;
        }

        /* è®²æ¼”å¤‡æ³¨åŒº */
        #notes-panel {
            margin-top: 20px;
            width: var(--slide-w);
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #notes-header { padding: 10px 15px; background: #f9f9f9; border-bottom: 1px solid #eee; font-size: 14px; color: #666; font-weight: bold; font-family: sans-serif; }
        #notes-input { width: 100%; height: 120px; padding: 15px; border: none; resize: vertical; font-family: sans-serif; font-size: 14px; line-height: 1.5; color: #333; box-sizing: border-box; outline: none; }

        /* === å…ƒç´ æ ·å¼ === */
        .element { 
            position: absolute; 
            cursor: move; 
            box-sizing: border-box; 
            /* æ ¸å¿ƒä¿®å¤ï¼šå…ƒç´ çº§å¼ºåˆ¶å­—ä½“ */
            font-family: var(--font-stack);
        }
        .element:hover { outline: 1px dashed #999; }
        .element.selected { outline: 2px solid var(--accent); z-index: 100; }
        .element[contenteditable="true"] { cursor: text; }
        
        .resizer { width: 12px; height: 12px; background: var(--accent); position: absolute; right: -6px; bottom: -6px; cursor: se-resize; display: none; z-index: 101; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.5); }
        .element.selected .resizer { display: block; }

        /* å®ç”¨ç±» */
        .fs-title { font-size: 44px; font-weight: bold; color: var(--primary); }
        .fs-sub { font-size: 32px; color: var(--primary); }
        .fs-body { font-size: 24px; color: var(--primary); }
        .fs-small { font-size: 20px; color: var(--primary); }
        .bg-accent { background-color: var(--accent); color: white; display: flex; align-items: center; justify-content: center; text-align: center; }
        .color-accent { color: var(--accent); }
        .shape-rect { border: 2px solid var(--accent); background: white; display: flex; align-items: center; justify-content: center; text-align: center; }
        .shape-line { background: var(--accent); }
        
        .logo-mark { position: absolute; top: 5%; right: 5%; width: 100px; height: 40px; background: #eee; border: 1px dashed #ccc; color: #999; display: flex; align-items: center; justify-content: center; font-size: 12px; pointer-events: none; }
        
        .speaker-notes { display: none; }

        /* é®ç½©å±‚ */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 999;
            display: none; align-items: center; justify-content: center;
            flex-direction: column; color: white; font-family: sans-serif;
        }
    </style>
</head>
<body>

<div id="overlay">
    <div style="font-size: 24px; margin-bottom: 20px;" id="overlay-msg">æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ PPT...</div>
    <div style="width: 300px; height: 10px; background: #333; border-radius: 5px;">
        <div id="progress-bar" style="width: 0%; height: 100%; background: #00ff00; border-radius: 5px; transition: 0.2s;"></div>
    </div>
</div>

<div id="sidebar">
    <div id="sidebar-header">IoTSP å¹»ç¯ç‰‡</div>
    <div id="sidebar-list">
        <div style="padding:20px; text-align:center; color:#999;" id="loading-msg">æ­£åœ¨æ¢æµ‹é¡µé¢...</div>
    </div>
</div>

<div id="main">
    <div id="toolbar">
        <div class="tool-group">
            <span style="font-size:14px; font-weight:bold; color:var(--accent);">PPT ç¼–è¾‘å™¨ Pro</span>
        </div>
        <div class="tool-group">
            <span id="page-indicator" style="font-size:14px; color:#333;">ç¬¬ 1 é¡µ</span>
            <button class="secondary" onclick="exportImagePPT()">ğŸ“· å¯¼å‡ºå…¨å›¾ PPT</button>
            <button onclick="exportEditPPT()">ğŸ“¥ å¯¼å‡ºå¯ç¼–è¾‘ PPT</button>
        </div>
    </div>

    <div id="workspace">
        <div id="canvas-wrapper">
            <div id="canvas"></div>
            <div class="logo-mark">Logoå ä½</div>
        </div>

        <!-- å¤‡æ³¨ç¼–è¾‘åŒº -->
        <div id="notes-panel">
            <div id="notes-header">ğŸ¤ è®²æ¼”å¤‡æ³¨ (Speaker Notes)</div>
            <textarea id="notes-input" placeholder="åœ¨æ­¤è¾“å…¥æœ¬é¡µçš„æ¼”è®²ç¨¿..."></textarea>
        </div>
    </div>
</div>

<script>
    // å…¨å±€çŠ¶æ€
    let TOTAL_PAGES = 0;
    let currentPage = 1;
    let pageCache = {}; 

    const canvas = document.getElementById('canvas');
    const notesInput = document.getElementById('notes-input');
    const sidebarList = document.getElementById('sidebar-list');
    const pageIndicator = document.getElementById('page-indicator');
    const overlay = document.getElementById('overlay');
    const overlayMsg = document.getElementById('overlay-msg');
    const progressBar = document.getElementById('progress-bar');

    // === 1. åˆå§‹åŒ–ä¸è‡ªåŠ¨æ¢æµ‹ ===
    window.onload = async () => { await detectPages(); };

    async function detectPages() {
        let count = 0;
        let maxTry = 50; 
        while (count < maxTry) {
            const nextIdx = count + 1;
            try {
                const response = await fetch(`pages/${nextIdx}.html`, { method: 'HEAD' });
                if (response.ok) count++; else break;
            } catch (e) {
                try {
                    const resGet = await fetch(`pages/${nextIdx}.html`);
                    if (resGet.ok) count++; else break;
                } catch(err) { break; }
            }
        }
        TOTAL_PAGES = count;
        if (TOTAL_PAGES === 0) {
            sidebarList.innerHTML = `<div style="padding:10px; color:red;">æœªæ‰¾åˆ° HTML æ–‡ä»¶ã€‚<br>è¯·æ£€æŸ¥ pages/ ç›®å½•ã€‚<br>ç¡®ä¿é€šè¿‡æœ¬åœ°æœåŠ¡å™¨ (localhost) è®¿é—®ã€‚</div>`;
            return;
        }
        renderSidebar();
        loadSlide(1);
    }

    function renderSidebar() {
        sidebarList.innerHTML = '';
        for (let i = 1; i <= TOTAL_PAGES; i++) {
            let div = document.createElement('div');
            div.className = 'thumb';
            div.innerHTML = `<span>ç¬¬ ${i} é¡µ</span> <span class="thumb-status" id="status-${i}"></span>`;
            div.onclick = () => loadSlide(i);
            div.id = `thumb-${i}`;
            sidebarList.appendChild(div);
        }
    }

    // === 2. é¡µé¢åŠ è½½ä¸ä¿å­˜é€»è¾‘ ===
    async function loadSlide(index, skipSave = false) {
        if (!skipSave && currentPage > 0 && canvas.innerHTML) saveCurrentState();

        if (document.querySelector('.thumb.active')) document.querySelector('.thumb.active').classList.remove('active');
        const activeThumb = document.getElementById(`thumb-${index}`);
        if(activeThumb) activeThumb.classList.add('active');
        
        currentPage = index;
        pageIndicator.innerText = `ç¬¬ ${index} / ${TOTAL_PAGES} é¡µ`;

        let htmlContent = "";
        if (pageCache[index]) {
            htmlContent = pageCache[index];
        } else {
            try {
                const res = await fetch(`pages/${index}.html?t=${Date.now()}`);
                if (!res.ok) throw new Error("Load failed");
                htmlContent = await res.text();
            } catch (e) { htmlContent = `<div style="padding:20px; color:red;">åŠ è½½å¤±è´¥: pages/${index}.html</div>`; }
        }

        canvas.innerHTML = htmlContent;
        const notesDiv = canvas.querySelector('.speaker-notes');
        notesInput.value = notesDiv ? notesDiv.innerText.trim() : "";
        initElements();
        
        return Promise.resolve();
    }

    function saveCurrentState() {
        document.querySelectorAll('.element').forEach(el => el.classList.remove('selected'));
        let notesDiv = canvas.querySelector('.speaker-notes');
        if (!notesDiv) {
            notesDiv = document.createElement('div');
            notesDiv.className = 'speaker-notes';
            notesDiv.style.display = 'none';
            canvas.appendChild(notesDiv);
        }
        notesDiv.innerText = notesInput.value;
        pageCache[currentPage] = canvas.innerHTML;
        const statusSpan = document.getElementById(`status-${currentPage}`);
        if (statusSpan) statusSpan.innerText = "â—";
    }

    function initElements() {
        document.querySelectorAll('.element').forEach(el => {
            if (!el.querySelector('.resizer')) {
                const resizer = document.createElement('div');
                resizer.className = 'resizer';
                el.appendChild(resizer);
            }
            el.onmousedown = (e) => {
                if (e.target.className === 'resizer') return;
                document.querySelectorAll('.element').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                let startX = e.clientX, startY = e.clientY;
                let startLeft = el.offsetLeft, startTop = el.offsetTop;
                let parentW = el.parentElement.offsetWidth, parentH = el.parentElement.offsetHeight;
                const onMove = (ev) => {
                    el.style.left = ((startLeft + ev.clientX - startX) / parentW * 100) + '%';
                    el.style.top = ((startTop + ev.clientY - startY) / parentH * 100) + '%';
                };
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', () => window.removeEventListener('mousemove', onMove), {once:true});
            };
            const resizer = el.querySelector('.resizer');
            resizer.onmousedown = (e) => {
                e.stopPropagation();
                let startX = e.clientX, startY = e.clientY;
                let startW = el.offsetWidth, startH = el.offsetHeight;
                let parentW = el.parentElement.offsetWidth, parentH = el.parentElement.offsetHeight;
                const onResize = (ev) => {
                    el.style.width = ((startW + ev.clientX - startX) / parentW * 100) + '%';
                    el.style.height = ((startH + ev.clientY - startY) / parentH * 100) + '%';
                };
                window.addEventListener('mousemove', onResize);
                window.addEventListener('mouseup', () => window.removeEventListener('mousemove', onResize), {once:true});
            };
        });
    }

    // === 3. å¯¼å‡ºå¯ç¼–è¾‘ PPT ===
    async function exportEditPPT() {
        saveCurrentState();
        const pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9';
        pptx.title = 'å¼€æºåŠ¨å‘˜å¤§ä¼š';

        for (let i = 1; i <= TOTAL_PAGES; i++) {
            const slide = pptx.addSlide();
            let htmlContent = pageCache[i] || (await (await fetch(`pages/${i}.html`)).text());
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');

            doc.querySelectorAll('.element').forEach(el => {
                const style = el.style;
                const opts = {
                    x: style.left || "0", y: style.top || "0", w: style.width, h: style.height,
                    // æ ¸å¿ƒä¿®å¤ï¼šæ˜¾å¼æŒ‡å®š PowerPoint æ ‡å‡†æ¥·ä½“åç§°
                    fontFace: "æ¥·ä½“", 
                    color: "000000"
                };
                if (el.classList.contains('fs-title')) { opts.fontSize = 44; opts.bold = true; }
                else if (el.classList.contains('fs-sub')) { opts.fontSize = 32; }
                else if (el.classList.contains('fs-body')) { opts.fontSize = 24; }
                else if (el.classList.contains('fs-small')) { opts.fontSize = 20; }

                if (el.classList.contains('color-accent')) opts.color = "023163";
                if (el.classList.contains('bg-accent')) { opts.fill = { color: "023163" }; opts.color = "FFFFFF"; }
                if (el.classList.contains('shape-rect')) { opts.line = { color: "023163", width: 2 }; }
                if (el.classList.contains('shape-line')) { opts.fill = { color: "023163" }; }
                if (el.style.fontWeight === 'bold') opts.bold = true;

                const clone = el.cloneNode(true);
                if (clone.querySelector('.resizer')) clone.querySelector('.resizer').remove();
                let text = clone.innerText.trim();

                if (el.classList.contains('shape-line')) slide.addShape(pptx.ShapeType.rect, opts);
                else if (el.classList.contains('shape-rect')) slide.addText(text, { ...opts, shape: pptx.ShapeType.rect });
                else slide.addText(text, opts);
            });

            slide.addShape(pptx.ShapeType.rect, { x: "88%", y: "5%", w: "10%", h: "8%", fill: { color: "F2F2F2" }, line: {color: "CCCCCC", dashType: "dash"} });
            slide.addText("LOGO", { x: "88%", y: "5%", w: "10%", h: "8%", fontSize: 10, align: "center", color: "999999" });
            
            const notesDiv = doc.querySelector('.speaker-notes');
            if (notesDiv) slide.addNotes(notesDiv.innerText.trim());
        }
        pptx.writeFile({ fileName: "IoTSP_å¯ç¼–è¾‘ç‰ˆ.pptx" });
    }

    // === 4. å¯¼å‡ºå…¨å›¾ PPT ===
    async function exportImagePPT() {
        saveCurrentState(); 
        const originalPage = currentPage; 
        
        overlay.style.display = 'flex';
        
        const pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9';
        pptx.title = 'å¼€æºåŠ¨å‘˜å¤§ä¼š(å›¾ç‰‡ç‰ˆ)';
        
        for (let i = 1; i <= TOTAL_PAGES; i++) {
            overlayMsg.innerText = `æ­£åœ¨å¤„ç†ç¬¬ ${i} / ${TOTAL_PAGES} é¡µ...`;
            progressBar.style.width = `${(i / TOTAL_PAGES) * 100}%`;
            
            await loadSlide(i, true); 
            
            // å‡†å¤‡æˆªå›¾ï¼šç§»é™¤äº¤äº’å…ƒç´ 
            document.querySelectorAll('.element').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.resizer').forEach(el => el.style.display = 'none');

            await new Promise(r => setTimeout(r, 200));

            try {
                // æ ¸å¿ƒä¿®å¤ï¼šscale: 2 ä¿è¯æ¸…æ™°åº¦
                const canvasEl = await html2canvas(document.getElementById('canvas'), { 
                    scale: 2,
                    useCORS: true, 
                    backgroundColor: "#ffffff"
                });
                const imgData = canvasEl.toDataURL('image/png');

                const slide = pptx.addSlide();
                slide.addImage({ data: imgData, x: 0, y: 0, w: "100%", h: "100%" });

                if (notesInput.value.trim()) {
                    slide.addNotes(notesInput.value.trim());
                }

            } catch (err) {
                console.error("Screen capture failed", err);
            }
        }

        overlayMsg.innerText = "æ­£åœ¨ç”Ÿæˆæ–‡ä»¶...";
        pptx.writeFile({ fileName: "IoTSP_å…¨å›¾ç‰ˆ.pptx" }).then(() => {
            overlay.style.display = 'none';
            loadSlide(originalPage); 
        });
    }

</script>
</body>
</html>