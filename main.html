<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoTSP PPT ç¼–è¾‘å™¨ Pro</title>
    <!-- å¼•å…¥ PptxGenJS -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        /* === å…¨å±€å˜é‡ === */
        :root {
            --primary: #000000;
            --accent: #023163;
            --bg: #f0f2f5;
            --slide-w: 960px;
            --slide-h: 540px;
            --sidebar-w: 220px;
        }
        
        body { margin: 0; display: flex; height: 100vh; background: var(--bg); font-family: "KaiTi", "æ¥·ä½“", serif; overflow: hidden; }

        /* === ä¾§è¾¹æ  === */
        #sidebar { 
            width: var(--sidebar-w); 
            background: white; 
            border-right: 1px solid #ddd; 
            display: flex; 
            flex-direction: column; 
            z-index: 10;
        }
        #sidebar-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; color: var(--accent); }
        #sidebar-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .thumb { 
            padding: 12px; 
            background: #fff; 
            border: 2px solid #eee; 
            cursor: pointer; 
            margin-bottom: 10px; 
            border-radius: 4px; 
            font-size: 14px;
            display: flex; 
            justify-content: space-between;
        }
        .thumb:hover { border-color: #ccc; }
        .thumb.active { border-color: var(--accent); background: #eef2f6; color: var(--accent); font-weight: bold; }
        .thumb-status { font-size: 12px; color: #999; }

        /* === ä¸»å·¥ä½œåŒº === */
        #main { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }
        
        /* å·¥å…·æ  */
        #toolbar { 
            height: 50px; 
            background: white; 
            border-bottom: 1px solid #ddd; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 20;
        }
        .tool-group { display: flex; align-items: center; gap: 15px; }
        button { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.secondary { background: #666; }

        /* ç”»å¸ƒæ»šåŠ¨åŒº */
        #workspace { 
            flex: 1; 
            overflow: auto; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            padding: 40px; 
            background: var(--bg);
        }

        /* PPT ç”»å¸ƒå®¹å™¨ */
        #canvas-wrapper { 
            position: relative; 
            box-shadow: 0 0 20px rgba(0,0,0,0.15); 
            border: 1px solid #ccc;
        }
        #canvas { 
            width: var(--slide-w); 
            height: var(--slide-h); 
            background: white; 
            position: relative; 
            overflow: hidden; 
        }

        /* è®²æ¼”å¤‡æ³¨åŒº */
        #notes-panel {
            margin-top: 20px;
            width: var(--slide-w);
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #notes-header {
            padding: 10px 15px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #666;
            font-weight: bold;
        }
        #notes-input {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: none;
            resize: vertical;
            font-family: sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            box-sizing: border-box;
            outline: none;
        }

        /* === å…ƒç´ æ ·å¼ === */
        .element { position: absolute; cursor: move; box-sizing: border-box; }
        .element:hover { outline: 1px dashed #999; }
        .element.selected { outline: 2px solid var(--accent); z-index: 100; }
        .element[contenteditable="true"] { cursor: text; }
        
        /* ç¼©æ”¾æ‰‹æŸ„ */
        .resizer { width: 12px; height: 12px; background: var(--accent); position: absolute; right: -6px; bottom: -6px; cursor: se-resize; display: none; z-index: 101; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.5); }
        .element.selected .resizer { display: block; }

        /* å®ç”¨ç±» */
        .fs-title { font-size: 44px; font-weight: bold; color: var(--primary); }
        .fs-sub { font-size: 32px; color: var(--primary); }
        .fs-body { font-size: 24px; color: var(--primary); }
        .fs-small { font-size: 20px; color: var(--primary); }
        .bg-accent { background-color: var(--accent); color: white; display: flex; align-items: center; justify-content: center; text-align: center; }
        .color-accent { color: var(--accent); }
        .shape-rect { border: 2px solid var(--accent); background: white; display: flex; align-items: center; justify-content: center; text-align: center; }
        .shape-line { background: var(--accent); }
        
        .logo-mark { position: absolute; top: 5%; right: 5%; width: 100px; height: 40px; background: #eee; border: 1px dashed #ccc; color: #999; display: flex; align-items: center; justify-content: center; font-size: 12px; pointer-events: none; }
        
        /* éšè—çš„å¤‡æ³¨å­˜å‚¨å®¹å™¨ï¼ˆä¸æ˜¾ç¤ºåœ¨ç”»å¸ƒä¸Šï¼‰ */
        .speaker-notes { display: none; }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="sidebar-header">IoTSP å¹»ç¯ç‰‡</div>
    <div id="sidebar-list">
        <div style="padding:20px; text-align:center; color:#999;" id="loading-msg">æ­£åœ¨æ¢æµ‹é¡µé¢...</div>
    </div>
</div>

<div id="main">
    <div id="toolbar">
        <div class="tool-group">
            <span style="font-size:14px; font-weight:bold; color:var(--accent);">PPT ç¼–è¾‘å™¨ Pro</span>
            <span style="font-size:12px; color:#666;">ï¼ˆè‡ªåŠ¨æ¢æµ‹é¡µæ•° + å¤‡æ³¨æ”¯æŒï¼‰</span>
        </div>
        <div class="tool-group">
            <span id="page-indicator" style="font-size:14px; color:#333;">ç¬¬ 1 é¡µ</span>
            <button onclick="exportPPT()">ğŸ“¥ å¯¼å‡º PPTX</button>
        </div>
    </div>

    <div id="workspace">
        <div id="canvas-wrapper">
            <div id="canvas"></div>
            <div class="logo-mark">Logoå ä½</div>
        </div>

        <!-- å¤‡æ³¨ç¼–è¾‘åŒº -->
        <div id="notes-panel">
            <div id="notes-header">ğŸ¤ è®²æ¼”å¤‡æ³¨ (Speaker Notes) - å¯¼å‡ºåå°†æ˜¾ç¤ºåœ¨PPTåº•éƒ¨</div>
            <textarea id="notes-input" placeholder="åœ¨æ­¤è¾“å…¥æœ¬é¡µçš„æ¼”è®²ç¨¿..."></textarea>
        </div>
    </div>
</div>

<script>
    // å…¨å±€çŠ¶æ€
    let TOTAL_PAGES = 0;
    let currentPage = 1;
    let pageCache = {}; // ç¼“å­˜æ ¼å¼: { 1: "html string", ... }

    // DOM å…ƒç´ 
    const canvas = document.getElementById('canvas');
    const notesInput = document.getElementById('notes-input');
    const sidebarList = document.getElementById('sidebar-list');
    const pageIndicator = document.getElementById('page-indicator');

    // === 1. åˆå§‹åŒ–ä¸è‡ªåŠ¨æ¢æµ‹ ===
    window.onload = async () => {
        await detectPages();
    };

    async function detectPages() {
        let count = 0;
        let maxTry = 50; // æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯
        
        // å¾ªç¯æ¢æµ‹ pages/1.html, pages/2.html ...
        while (count < maxTry) {
            const nextIdx = count + 1;
            try {
                // ä½¿ç”¨ HEAD è¯·æ±‚æ¢æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ (æˆ–è€… GET)
                const response = await fetch(`pages/${nextIdx}.html`, { method: 'HEAD' });
                if (response.ok) {
                    count++;
                } else {
                    break; // é‡åˆ° 404 åœæ­¢
                }
            } catch (e) {
                // å¦‚æœ HEAD ä¸æ”¯æŒï¼Œå°è¯• GET
                try {
                    const resGet = await fetch(`pages/${nextIdx}.html`);
                    if (resGet.ok) count++; else break;
                } catch(err) {
                    break;
                }
            }
        }

        TOTAL_PAGES = count;
        
        if (TOTAL_PAGES === 0) {
            sidebarList.innerHTML = `<div style="padding:10px; color:red;">æœªæ‰¾åˆ° HTML æ–‡ä»¶ã€‚<br>è¯·æ£€æŸ¥ pages/ ç›®å½•æˆ–æœ¬åœ°æœåŠ¡å™¨è®¾ç½®ã€‚</div>`;
            return;
        }

        renderSidebar();
        loadSlide(1);
    }

    function renderSidebar() {
        sidebarList.innerHTML = '';
        for (let i = 1; i <= TOTAL_PAGES; i++) {
            let div = document.createElement('div');
            div.className = 'thumb';
            div.innerHTML = `<span>ç¬¬ ${i} é¡µ</span> <span class="thumb-status" id="status-${i}"></span>`;
            div.onclick = () => loadSlide(i);
            div.id = `thumb-${i}`;
            sidebarList.appendChild(div);
        }
    }

    // === 2. é¡µé¢åŠ è½½ä¸ä¿å­˜é€»è¾‘ ===

    async function loadSlide(index) {
        // 1. ä¿å­˜å½“å‰é¡µé¢çš„ä¿®æ”¹ï¼ˆå«å¤‡æ³¨ï¼‰
        if (currentPage > 0 && canvas.innerHTML) {
            saveCurrentState();
        }

        // 2. æ›´æ–° UI é€‰ä¸­çŠ¶æ€
        if (document.querySelector('.thumb.active')) {
            document.querySelector('.thumb.active').classList.remove('active');
        }
        const activeThumb = document.getElementById(`thumb-${index}`);
        if(activeThumb) activeThumb.classList.add('active');
        
        currentPage = index;
        pageIndicator.innerText = `ç¬¬ ${index} / ${TOTAL_PAGES} é¡µ`;

        // 3. è·å–å†…å®¹ (ä¼˜å…ˆç¼“å­˜)
        let htmlContent = "";
        if (pageCache[index]) {
            htmlContent = pageCache[index];
        } else {
            try {
                const res = await fetch(`pages/${index}.html?t=${Date.now()}`); // é˜²æ­¢æµè§ˆå™¨ç¼“å­˜æ–‡ä»¶
                if (!res.ok) throw new Error("Load failed");
                htmlContent = await res.text();
            } catch (e) {
                htmlContent = `<div style="padding:20px; color:red;">åŠ è½½å¤±è´¥: pages/${index}.html</div>`;
            }
        }

        // 4. æ¸²æŸ“ HTML
        canvas.innerHTML = htmlContent;

        // 5. æå–å¤‡æ³¨å¹¶å¡«å……åˆ° Textarea
        const notesDiv = canvas.querySelector('.speaker-notes');
        if (notesDiv) {
            notesInput.value = notesDiv.innerText.trim();
        } else {
            notesInput.value = ""; // æ— å¤‡æ³¨
        }

        // 6. åˆå§‹åŒ–äº¤äº’ (æ‹–æ‹½/ç¼©æ”¾)
        initElements();
    }

    function saveCurrentState() {
        // ç§»é™¤é€‰ä¸­æ¡†
        document.querySelectorAll('.element').forEach(el => el.classList.remove('selected'));
        
        // 1. å°† Textarea çš„å†…å®¹å›å†™åˆ° HTML çš„éšè— div ä¸­
        let notesDiv = canvas.querySelector('.speaker-notes');
        const currentNotes = notesInput.value;
        
        if (!notesDiv) {
            // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
            notesDiv = document.createElement('div');
            notesDiv.className = 'speaker-notes';
            notesDiv.style.display = 'none';
            canvas.appendChild(notesDiv);
        }
        notesDiv.innerText = currentNotes; // ä¿å­˜æ–‡æœ¬

        // 2. æ›´æ–°ç¼“å­˜
        pageCache[currentPage] = canvas.innerHTML;
        
        // æ›´æ–°ä¾§è¾¹æ çŠ¶æ€ï¼Œæç¤ºå·²ä¿®æ”¹
        const statusSpan = document.getElementById(`status-${currentPage}`);
        if (statusSpan) statusSpan.innerText = "å·²ç¼“å­˜";
    }

    // === 3. å…ƒç´ äº¤äº’ (æ‹–æ‹½ & ç¼©æ”¾) ===
    function initElements() {
        document.querySelectorAll('.element').forEach(el => {
            // è¡¥å…¨ç¼©æ”¾æ‰‹æŸ„
            if (!el.querySelector('.resizer')) {
                const resizer = document.createElement('div');
                resizer.className = 'resizer';
                el.appendChild(resizer);
            }

            // æ‹–æ‹½
            el.onmousedown = (e) => {
                if (e.target.className === 'resizer') return;
                document.querySelectorAll('.element').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                
                let startX = e.clientX, startY = e.clientY;
                let startLeft = el.offsetLeft, startTop = el.offsetTop;
                let parentW = el.parentElement.offsetWidth, parentH = el.parentElement.offsetHeight;

                const onMove = (ev) => {
                    let dx = ev.clientX - startX;
                    let dy = ev.clientY - startY;
                    el.style.left = ((startLeft + dx) / parentW * 100) + '%';
                    el.style.top = ((startTop + dy) / parentH * 100) + '%';
                };
                const onUp = () => {
                    window.removeEventListener('mousemove', onMove);
                    window.removeEventListener('mouseup', onUp);
                };
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onUp);
            };

            // ç¼©æ”¾
            const resizer = el.querySelector('.resizer');
            resizer.onmousedown = (e) => {
                e.stopPropagation();
                let startX = e.clientX, startY = e.clientY;
                let startW = el.offsetWidth, startH = el.offsetHeight;
                let parentW = el.parentElement.offsetWidth, parentH = el.parentElement.offsetHeight;

                const onResize = (ev) => {
                    let dx = ev.clientX - startX;
                    let dy = ev.clientY - startY;
                    el.style.width = ((startW + dx) / parentW * 100) + '%';
                    el.style.height = ((startH + dy) / parentH * 100) + '%';
                };
                const onStop = () => {
                    window.removeEventListener('mousemove', onResize);
                    window.removeEventListener('mouseup', onStop);
                };
                window.addEventListener('mousemove', onResize);
                window.addEventListener('mouseup', onStop);
            };
        });
    }

    // ç›‘å¬å¤‡æ³¨è¾“å…¥æ¡†çš„ä¿®æ”¹ï¼Œå®æ—¶ä¿å­˜åˆ°DOM(å¯é€‰ï¼Œé˜²æ­¢æ„å¤–ä¸¢å¤±)
    notesInput.addEventListener('input', () => {
        // è¿™é‡Œä¸åšæ“ä½œï¼Œç­‰åˆ°åˆ‡æ¢é¡µé¢æˆ–å¯¼å‡ºæ—¶ç»Ÿä¸€ä¿å­˜
    });

    // === 4. å¯¼å‡º PPTX ===
    async function exportPPT() {
        saveCurrentState(); // ä¿å­˜å½“å‰åœç•™é¡µé¢çš„çŠ¶æ€

        const pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9';
        pptx.author = 'IoTSP Lab';
        pptx.title = 'å¼€æºåŠ¨å‘˜å¤§ä¼š';

        // éå†æ‰€æœ‰é¡µé¢
        for (let i = 1; i <= TOTAL_PAGES; i++) {
            const slide = pptx.addSlide();
            let htmlContent = "";

            // è·å–æ•°æ®
            if (pageCache[i]) {
                htmlContent = pageCache[i];
            } else {
                try {
                    const res = await fetch(`pages/${i}.html`);
                    htmlContent = await res.text();
                } catch(e) { console.error("Export error load file", i); continue; }
            }

            // è§£æ DOM
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');

            // 1. å¤„ç†å¯è§†å…ƒç´ 
            const elements = doc.querySelectorAll('.element');
            elements.forEach(el => {
                const style = el.style;
                const opts = {
                    x: style.left || "0", y: style.top || "0",
                    w: style.width, h: style.height,
                    fontFace: "æ¥·ä½“", color: "000000"
                };

                // æ ·å¼æ˜ å°„
                if (el.classList.contains('fs-title')) { opts.fontSize = 44; opts.bold = true; }
                else if (el.classList.contains('fs-sub')) { opts.fontSize = 32; }
                else if (el.classList.contains('fs-body')) { opts.fontSize = 24; }
                else if (el.classList.contains('fs-small')) { opts.fontSize = 20; }

                if (el.classList.contains('color-accent')) opts.color = "023163";
                if (el.classList.contains('bg-accent')) { opts.fill = { color: "023163" }; opts.color = "FFFFFF"; }
                if (el.classList.contains('shape-rect')) { opts.line = { color: "023163", width: 2 }; }
                if (el.classList.contains('shape-line')) { opts.fill = { color: "023163" }; }
                if (el.style.fontWeight === 'bold') opts.bold = true;

                // ç§»é™¤ resizer å¹²æ‰°
                const clone = el.cloneNode(true);
                if (clone.querySelector('.resizer')) clone.querySelector('.resizer').remove();
                let text = clone.innerText.trim();

                // æ¸²æŸ“
                if (el.classList.contains('shape-line')) {
                    slide.addShape(pptx.ShapeType.rect, opts);
                } else if (el.classList.contains('shape-rect')) {
                    slide.addText(text, { ...opts, shape: pptx.ShapeType.rect });
                } else {
                    slide.addText(text, opts);
                }
            });

            // 2. æ·»åŠ  Logo
            slide.addShape(pptx.ShapeType.rect, { x: "88%", y: "5%", w: "10%", h: "8%", fill: { color: "F2F2F2" }, line: {color: "CCCCCC", dashType: "dash"} });
            slide.addText("LOGO", { x: "88%", y: "5%", w: "10%", h: "8%", fontSize: 10, align: "center", color: "999999" });

            // 3. æ·»åŠ è®²æ¼”å¤‡æ³¨ (æ ¸å¿ƒéœ€æ±‚)
            const notesDiv = doc.querySelector('.speaker-notes');
            if (notesDiv && notesDiv.innerText.trim() !== "") {
                slide.addNotes(notesDiv.innerText.trim());
            }
        }

        pptx.writeFile({ fileName: "IoTSP_Exported_Pro.pptx" });
    }

</script>
</body>
</html>